from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer
from datetime import datetime
import hashlib
import os

# ==============================
# ğŸ“„ ConfiguraÃ§Ãµes iniciais
# ==============================
output_dir = r"H:\Reserva\Pessoal\Sistema vendas e orÃ§amento\SisUno_Base_v0.1\docs\Relatorios_Tecnicos"
output_path = os.path.join(output_dir, "Relatorio_Tecnico_SisUno_v1.2.pdf")
log_file = os.path.join(output_dir, "sisuno_version_log.txt")

# ==============================
# ğŸ§© ConteÃºdo principal
# ==============================
report_text = """
========================================
RELATÃ“RIO TÃ‰CNICO CONSOLIDADO
SISUNO â€“ VERSÃƒO 1.2
========================================
ğŸ“… Data de emissÃ£o: {data}
ğŸ§‘â€ğŸ’» ResponsÃ¡vel tÃ©cnico: Officina â€“ Desenvolvimento interno
ğŸ“ Caminho de arquivamento:
{path}
========================================

1ï¸âƒ£ OBJETIVO DA VERSÃƒO
----------------------------------------
Consolidar a integraÃ§Ã£o entre os mÃ³dulos de:
- OrÃ§amentos
- Financeiro
- Pacotes de orÃ§amentos
- Controle de faturas de cartÃ£o

A versÃ£o 1.2 visa permitir o agrupamento de orÃ§amentos individuais de um mesmo cliente
em um pacote consolidado, alÃ©m de registrar despesas parceladas em cartÃµes e associÃ¡-las
a faturas para melhor gestÃ£o financeira.

----------------------------------------
2ï¸âƒ£ ESTRUTURA DO BANCO DE DADOS
----------------------------------------

Tabelas criadas:
- pacote_orcamento
- pacote_orcamento_itens
- cartao_fatura
- cartao_fatura_itens

Views atualizadas:
- vw_orcamentos_com_custos
- vw_faturas_cartao_resumo

----------------------------------------
3ï¸âƒ£ DESCRIÃ‡ÃƒO FUNCIONAL
----------------------------------------

ğŸ§© PACOTE DE ORÃ‡AMENTOS
Permite agrupar mÃºltiplos orÃ§amentos de um mesmo cliente sob um cÃ³digo de pacote.

ğŸ’³ CONTROLE DE FATURAS DE CARTÃƒO
Registra despesas realizadas via cartÃ£o de crÃ©dito e gera faturas mensais consolidadas.

ğŸ§¾ VIEW vw_orcamentos_com_custos
Consolida dados de orÃ§amentos com custos operacionais e de deslocamento.

ğŸ“Š VIEW vw_faturas_cartao_resumo
Exibe um resumo das faturas com valores totais, pagos e pendentes.

----------------------------------------
4ï¸âƒ£ RESULTADOS DE TESTES
----------------------------------------
âœ… Pacote de orÃ§amento criado com sucesso.
âœ… Fatura e itens de cartÃ£o criados e validados.
âœ… Views atualizadas funcionando corretamente apÃ³s correÃ§Ã£o.
ğŸ Status geral: Teste concluÃ­do com sucesso.

----------------------------------------
5ï¸âƒ£ ANÃLISE DE INTEGRAÃ‡ÃƒO
----------------------------------------
As views refletem corretamente as relaÃ§Ãµes entre orÃ§amentos, custos e financeiro.
O mÃ³dulo de pacotes permite emissÃ£o de relatÃ³rios consolidados para negociaÃ§Ã£o com o cliente.

----------------------------------------
6ï¸âƒ£ INSTRUÃ‡Ã•ES DE ARQUIVAMENTO
----------------------------------------
ğŸ“‚ DiretÃ³rio padrÃ£o:
H:\\Reserva\\Pessoal\\Sistema vendas e orÃ§amento\\SisUno_Base_v0.1\\docs\\Relatorios_Tecnicos\\
ğŸ“„ Nome do arquivo:
Relatorio_Tecnico_SisUno_v1.2.pdf

----------------------------------------
ğŸ”– ObservaÃ§Ãµes:
Esta versÃ£o marca o inÃ­cio da integraÃ§Ã£o financeira completa do sistema.
========================================
"""

# ==============================
# ğŸ§¾ CriaÃ§Ã£o do relatÃ³rio PDF
# ==============================
styles = getSampleStyleSheet()
doc = SimpleDocTemplate(output_path, pagesize=A4)
content = [
    Paragraph("RELATÃ“RIO TÃ‰CNICO CONSOLIDADO - SISUNO v1.2", styles["Title"]),
    Spacer(1, 12),
    Paragraph(report_text.format(data=datetime.now().strftime("%Y-%m-%d %H:%M"), path=output_path), styles["BodyText"]),
    Spacer(1, 12)
]

# Assinatura digital automÃ¡tica
timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
sign_data = f"SisUno_v1.2_{timestamp}".encode()
signature = hashlib.sha256(sign_data).hexdigest()

content.append(Spacer(1, 12))
content.append(Paragraph(f"ğŸ” Assinatura Digital: {signature}", styles["BodyText"]))
content.append(Paragraph(f"ğŸ•’ Gerado em: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}", styles["BodyText"]))

doc.build(content)

# ==============================
# ğŸª¶ Registro no log de versÃµes
# ==============================
with open(log_file, "a", encoding="utf-8") as f:
    f.write(f"\n=== SISUNO v1.2 ===\n")
    f.write(f"Data: {datetime.now()}\n")
    f.write(f"Arquivo: {output_path}\n")
    f.write(f"Assinatura: {signature}\n")
    f.write(f"DescriÃ§Ã£o: ConsolidaÃ§Ã£o financeira e de pacotes de orÃ§amento.\n")
    f.write("="*50 + "\n")

print("âœ… RelatÃ³rio tÃ©cnico v1.2 gerado e assinado com sucesso!")
print(f"ğŸ“‚ Caminho: {output_path}")
print(f"ğŸ” Assinatura: {signature}")
print(f"ğŸ—’ï¸ Registro salvo em: {log_file}")
